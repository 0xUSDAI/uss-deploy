#!/usr/bin/env bash
set -ex

export ETH_GAS=${ETH_GAS:-"7000000"}
export ETH_FROM=${ETH_FROM:-$(seth rpc eth_coinbase)}

# dependencies
(test -z $MCD_DEPLOY) && exit 1
MCD_ADM=0x$(seth call $MCD_DEPLOY "authority()(address)")

# deploy patch
MCD_PATCH_01=$(dapp create Patch01 $MCD_DEPLOY)
seth send $MCD_ADM 'setRootUser(address,bool)' $MCD_PATCH_01 true

# run the upgrades
seth send $MCD_PATCH_01 'apply()'

cat > load-mcd-$(seth chain) << EOF
#!/bin/bash

# mcd patch on $(seth chain) from $(git rev-parse HEAD)
# $(date)
export MCD_DEPLOY=$MCD_DEPLOY
export MCD_PATCH_01=$MCD_PATCH_01
export MCD_DAI=0x$(seth call $MCD_PATCH_01 "dai()(address)")
export MCD_DAI_GUARD=0x$(seth call $MCD_PATCH_01 "guard()(address)")
EOF
