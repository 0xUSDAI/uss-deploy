#!/usr/bin/env bash
set -ex

# dependencies
(test -z $MCD_DEPLOY) && exit 1
(test -z $MCD_VAT) && exit 1
(test -z $MCD_MOM) && exit 1
(test -z $MCD_PIT) && exit 1
(test -z $MCD_FLAP) && exit 1
(test -z $MCD_FLOP) && exit 1
(test -z $MCD_FLIP_ETH) && exit 1

patch=$(dapp create Patch03)
MCD_VOW_FAB=$(dapp create VowFab)
MCD_CAT_FAB=$(dapp create CatFab)

seth send $patch 'upgrade_vow(address,address,address,address,address)' $MCD_VOW_FAB $MCD_VAT $MCD_FLAP $MCD_FLOP $MCD_MOM
seth send $patch 'upgrade_cat(address,address,address,address,address)' $MCD_CAT_FAB $MCD_VAT $MCD_PIT $MCD_FLIP_ETH $MCD_MOM

MCD_VOW=0x$(seth call $patch 'vow()(address)')
MCD_CAT=0x$(seth call $patch 'cat()(address)')

seth send $MCD_VAT 'rely(address)' $MCD_VOW

cat > load-mcd-$(seth chain) << EOF
#!/bin/bash

# mcd patch on $(seth chain) from $(git rev-parse HEAD)
# $(date)
export MCD_CAT=$MCD_CAT
export MCD_VOW=$MCD_VOW
EOF
