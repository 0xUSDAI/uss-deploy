#!/usr/bin/env bash
set -ex

export ETH_GAS=${ETH_GAS:-"7000000"}
export ETH_FROM=${ETH_FROM:-$(seth rpc eth_coinbase)}

test -z "$SKIP_BUILD" && dapp build

# dependencies
(test -z $MCD_DEPLOY) && exit 1
MCD_ADM=0x$(seth call $MCD_DEPLOY "authority()(address)")

# deploy new fabs
MCD_VOW_FAB=$(dapp create VowFab)
MCD_CAT_FAB=$(dapp create CatFab)

# deploy patch
MCD_PATCH_00=$(dapp create Patch00 $MCD_DEPLOY)

# authorise this with previous deployer
seth send $MCD_ADM 'setRootUser(address,bool)' $MCD_PATCH_00 true

# run the upgrades
seth send $MCD_PATCH_00 'upgrade_vow(address)' $MCD_VOW_FAB
seth send $MCD_PATCH_00 'upgrade_cat(address)' $MCD_CAT_FAB
seth send $MCD_PATCH_00 'apply()'

cat > load-mcd-$(seth chain) << EOF
#!/bin/bash

# mcd patch on $(seth chain) from $(git rev-parse HEAD)
# $(date)
export MCD_DEPLOY=$MCD_DEPLOY
export MCD_VOW_FAB=$MCD_VOW_FAB
export MCD_CAT_FAB=$MCD_CAT_FAB
export MCD_PATCH_00=$MCD_PATCH_00
export MCD_CAT=0x$(seth call $MCD_PATCH_00 "cat()(address)")
export MCD_VOW=0x$(seth call $MCD_PATCH_00 "vow()(address)")
EOF
